<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bun-lmdb-connector API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900">
    <div class="min-h-full">
        <nav class="bg-indigo-600 dark:bg-gray-800">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 text-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-cog h-8 w-8"><circle cx="12" cy="17" r="3"/><path d="M4.2 15.1A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.2"/><path d="m15.7 18.4-.9-.3"/><path d="m9.2 15.9-.9-.3"/><path d="m10.6 20.7.3-.9"/><path d="m13.1 14.2.3-.9"/><path d="m13.6 20.7-.4-1"/><path d="m10.8 14.3-.4-1"/><path d="m8.3 18.6 1-.4"/><path d="m14.7 15.8 1-.4"/></svg>
                        </div>
                        <div class="ml-2 flex items-baseline space-x-4">
                            <span class="text-white text-lg font-bold">API ConnectY</span>
                        </div>
                    </div>
                    <div class="ml-4 flex items-center md:ml-6">
                        <button id="darkModeToggle" type="button" class="rounded-full bg-indigo-600 dark:bg-gray-800 p-1 text-indigo-200 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-indigo-600">
                            <span class="sr-only">Toggle dark mode</span>
                            <svg id="lightIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                            </svg>
                            <svg id="darkIcon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <header class="bg-white dark:bg-gray-700 shadow">
            <div class="mx-auto max-w-7xl py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-xl font-bold tracking-tight text-gray-900 dark:text-white">Example API Tester</h1>
            </div>
        </header>

        <main>
            <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <div class="overflow-hidden rounded-lg bg-white dark:bg-gray-800 shadow">
                        <div class="px-4 py-5 sm:p-6">
                            <form id="serverForm" class="space-y-6">
                                <div>
                                    <label for="serverUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Server URL</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" name="serverUrl" id="serverUrl" class="block w-full pl-2 rounded-none rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 dark:bg-gray-700 h-8 dark:text-white dark:border-gray-600" placeholder="http://localhost:5000">
                                        <button type="submit" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-indigo-600 px-3 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Connect</button>
                                    </div>
                                </div>
                            </form>

                            <form id="apiForm" class="space-y-6 hidden">
                                <div>
                                    <label for="dbName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Database Name</label>
                                    <div class="mt-1">
                                        <input type="text" name="dbName" id="dbName" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 dark:bg-gray-700 h-8 dark:text-white dark:border-gray-600">
                                    </div>
                                </div>

                                <div>
                                    <label for="action" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Action</label>
                                    <select id="action" name="action" required class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm bg-gray-100 dark:bg-gray-700 h-8 dark:text-white dark:border-gray-600">
                                        <option value="get">Get</option>
                                        <option value="put">Put</option>
                                        <option value="delete">Delete</option>
                                        <option value="getAll">Get All</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Key</label>
                                    <div class="mt-1">
                                        <input type="text" name="key" id="key" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 dark:bg-gray-700 h-8 dark:text-white dark:border-gray-600">
                                    </div>
                                </div>

                                <div>
                                    <label for="value" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Value</label>
                                    <div class="mt-1">
                                        <input type="text" name="value" id="value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 dark:bg-gray-700 h-8 dark:text-white dark:border-gray-600">
                                    </div>
                                </div>

                                <div>
                                    <button type="submit" class="flex w-full justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Send Request</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="mt-8 bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h2 class="text-lg font-medium text-gray-900 dark:text-white">How to deploy bun-lmdb-connector</h2>
                            <div class="mt-5 text-sm text-gray-500 dark:text-gray-400">
                                <ol class="list-decimal list-inside space-y-2">
                                    <li>Install Bun: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">curl -fsSL https://bun.sh/install | bash</code></li>
                                    <li>Clone the repository: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">git clone https://github.com/alexy-os/bun-lmdb-connector.git</code></li>
                                    <li>Navigate to the project directory: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">cd bun-lmdb-connector</code></li>
                                    <li>Install dependencies: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">bun install</code></li>
                                    <li>Start the server: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">bun run src/index.ts</code></li>
                                    <li>The server will start on http://localhost:5000 by default</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="successBanner" class="fixed bottom-0 inset-x-0 pb-2 sm:pb-5 hidden">
            <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
                <div class="rounded-lg bg-green-600 p-2 shadow-lg sm:p-3">
                    <div class="flex flex-wrap items-center justify-between">
                        <div class="flex w-0 flex-1 items-center">
                            <span class="flex rounded-lg bg-green-800 p-2">
                                <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                </svg>
                            </span>
                            <p class="ml-3 truncate font-medium text-white">
                                <span class="md:hidden">Request successful!</span>
                                <span class="hidden md:inline">Great news! Your API request was processed successfully.</span>
                            </p>
                        </div>
                        <div class="order-2 flex-shrink-0 sm:order-3 sm:ml-2">
                            <button type="button" id="closeBanner" class="-mr-1 flex rounded-md p-2 hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-white">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const serverForm = document.getElementById('serverForm');
        const apiForm = document.getElementById('apiForm');
        const successBanner = document.getElementById('successBanner');
        const closeBanner = document.getElementById('closeBanner');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const lightIcon = document.getElementById('lightIcon');
        const darkIcon = document.getElementById('darkIcon');
        let baseUrl = '';

        // Dark mode functionality
        function setDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
        }

        // Check for saved dark mode preference
        const savedDarkMode = localStorage.getItem('darkMode');
        if (savedDarkMode === 'true') {
            setDarkMode(true);
        }

        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            setDarkMode(isDark);
        });

        serverForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            baseUrl = document.getElementById('serverUrl').value.trim();
            if (!baseUrl) {
                showError('Please enter a server URL');
                return;
            }

            // Проверка на корректность URL и удаление завершающего слэша
            try {
                const url = new URL(baseUrl);
                baseUrl = url.origin + url.pathname.replace(/\/$/, '');
            } catch (_) {
                showError('Invalid URL format. Please enter a valid URL (e.g., http://localhost:5000)');
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/api`, { 
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: AbortSignal.timeout(5000) // 5 секунд таймаут
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new TypeError("The server response was not in JSON format as expected.");
                }

                const databases = await response.json();
                if (typeof databases !== 'object') {
                    throw new Error('Invalid response from server. Expected an object.');
                }

                const dbNames = Object.keys(databases);
                if (dbNames.length === 0) {
                    showWarning('No databases found on the server. You can still use the form to create a new database.');
                }

                document.getElementById('dbName').value = dbNames[0] || '';
                serverForm.classList.add('hidden');
                apiForm.classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                let errorMessage = 'Failed to connect to server. ';
                if (error.name === 'AbortError') {
                    errorMessage += 'The request timed out. The server might be down or unreachable.';
                } else if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                    errorMessage += 'The server is unreachable. Please check if the server is running and the URL is correct.';
                } else if (error instanceof Error) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'An unknown error occurred.';
                }
                showError(errorMessage);
            }
        });

        apiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dbName = document.getElementById('dbName').value;
            const action = document.getElementById('action').value;
            const key = document.getElementById('key').value;
            const value = document.getElementById('value').value;
            
            let url = `${baseUrl}/api/${dbName}`;
            let method = 'GET';
            let body = null;
            
            switch (action) {
                case 'get':
                    url += `/${key}`;
                    break;
                case 'put':
                    method = 'POST';
                    body = JSON.stringify({ key, value });
                    break;
                case 'delete':
                    method = 'DELETE';
                    url += `/${key}`;
                    break;
                case 'getAll':
                    // URL remains unchanged
                    break;
            }
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body,
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get("content-type");
                let result;
                if (contentType && contentType.includes("application/json")) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }
                console.log('Response:', result);
                
                // Показываем баннер успеха
                showSuccessBanner();

                // Очищаем поля формы после успешного запроса
                if (action !== 'getAll') {
                    document.getElementById('key').value = '';
                    document.getElementById('value').value = '';
                }

                // Если это был запрос 'put', обновляем список баз данных
                if (action === 'put') {
                    updateDatabaseList();
                }
            } catch (error) {
                console.error('Error:', error);
                showError(`An error occurred while processing your request: ${error.message}`);
            }
        });

        // Функция для обновления списка баз данных
        async function updateDatabaseList() {
            try {
                const response = await fetch(`${baseUrl}/api`, { 
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const databases = await response.json();
                const dbNames = Object.keys(databases);
                
                // Обновляем поле выбора базы данных
                const dbNameInput = document.getElementById('dbName');
                const currentValue = dbNameInput.value;
                dbNameInput.innerHTML = dbNames.map(name => `<option value="${name}">${name}</option>`).join('');
                dbNameInput.value = currentValue; // Сохраняем текущее значение
            } catch (error) {
                console.error('Error updating database list:', error);
            }
        }

        function showError(message) {
            showBanner(message, 'red');
        }

        function showWarning(message) {
            showBanner(message, 'yellow');
        }

        function showBanner(message, color) {
            const banner = document.createElement('div');
            banner.className = `bg-${color}-100 border border-${color}-400 text-${color}-700 px-4 py-3 rounded relative mb-4`;
            banner.role = 'alert';
            banner.innerHTML = `
                <strong class="font-bold">${color === 'red' ? 'Error!' : 'Warning!'}</strong>
                <span class="block sm:inline">${message}</span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                    <svg class="fill-current h-6 w-6 text-${color}-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <title>Close</title>
                        <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                    </svg>
                </span>
            `;
            serverForm.insertAdjacentElement('beforebegin', banner);
            
            const closeButton = banner.querySelector('svg');
            closeButton.addEventListener('click', () => {
                banner.remove();
            });

            setTimeout(() => {
                banner.remove();
            }, 5000);
        }

        function showSuccessBanner() {
            successBanner.classList.remove('hidden');
            setTimeout(() => {
                successBanner.classList.add('hidden');
            }, 5000);
        }

        closeBanner.addEventListener('click', () => {
            successBanner.classList.add('hidden');
        });
    </script>
</body>
</html>